Bootstrap: docker
From: ${BASE_IMAGE}

%labels
    Author OpenSci
    Version 0.1.0
    Base ${BASE_IMAGE}
    Description Megatron container based on NVIDIA PyTorch with full HPC support

%environment
    export PYTHONNOUSERSITE=1
    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export PYTHONPATH=/workspace/oellm-autoexp/submodules/Megatron-LM:/workspace/oellm-autoexp:${PYTHONPATH}
    export OELLM_AUTOEXP_CACHE=/workspace/cache
    export HF_HOME=/workspace/cache/hf

%files
    ${REPO_ROOT} /workspace/oellm-autoexp
    ${REQUIREMENTS_PATH} /workspace/${REQUIREMENTS_BASENAME}

%post
mkdir -p /workspace/cache
cd /workspace

pip install --upgrade pip setuptools wheel

cd oellm-autoexp
pip install -e .[dev]

# startup script that fixes CUDA symlinks
mkdir -p /.singularity.d/env
cat > /.singularity.d/env/99-cuda-fix.sh << 'EOFENV'
#!/bin/bash
# Fix CUDA symlinks for Triton when --nv is used
if [ -f /.singularity.d/libs/libcuda.so.1 ]; then
mkdir -p /usr/local/cuda/lib64 /usr/local/cuda/compat/lib 2>/dev/null
ln -sf /.singularity.d/libs/libcuda.so.1 /usr/local/cuda/lib64/libcuda.so.1 2>/dev/null
ln -sf /usr/local/cuda/lib64/libcuda.so.1 /usr/local/cuda/lib64/libcuda.so 2>/dev/null
ln -sf /.singularity.d/libs/libcuda.so.1 /usr/local/cuda/compat/lib/libcuda.so.1 2>/dev/null
ln -sf /usr/local/cuda/compat/lib/libcuda.so.1 /usr/local/cuda/compat/lib/libcuda.so 2>/dev/null
fi
export LD_LIBRARY_PATH=/.singularity.d/libs:/usr/local/cuda/lib64:${LD_LIBRARY_PATH}
EOFENV
chmod +x /.singularity.d/env/99-cuda-fix.sh

%runscript
cd /workspace/oellm-autoexp
exec "$@"

%startscript
cd /workspace/oellm-autoexp
exec "$@"

%test
cd /workspace/oellm-autoexp
python scripts/run_autoexp.py --help >/dev/null

%help
    Build with container/build_container.sh and run via
    `apptainer exec MegatronTraining.sif python -m oellm_autoexp.plan`.
