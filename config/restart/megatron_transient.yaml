# Restart policy for transient Megatron errors
# Restarts on: hangs, NCCL errors, communication issues
# Does NOT restart on: OOM, code bugs, numerical instability

policies:
  - mode: crash
    implementation:
      class_name: SelectiveRestartPolicy
      max_retries: 3
      restart_reason: Transient failure detected, restarting job
      stop_reason: Permanent failure detected, stopping job
      default_action: restart  # Restart by default on crashes unless excluded

      # Restart on these error types (transient/recoverable)
      restart_on_error_types:
        - hang               # CUDA hangs, training stuck
        - deadlock           # Distributed deadlock
        - nccl               # NCCL errors
        - nccl_timeout       # NCCL timeout
        - distributed_timeout # ProcessGroup timeout
        - communication      # Socket/connection errors
        - watchdog_timeout   # Watchdog timeouts
        - nccl_collective    # NCCL collective operation failures
        - cancelled          # Job cancelled (e.g., manual scancel, preemption)
        - slurm_failure      # SLURM job failures

      # Restart on these subsystems (likely transient)
      restart_on_subsystems:
        - distributed        # All distributed communication issues
        - slurm              # SLURM-related issues (cancellation, node failures)

      # Restart on these specific signals
      restart_on_signals:
        - cuda_hang
        - deadlock
        - nccl_error
        - nccl_timeout
        - processgroup_timeout
        - communication_error

      # Never restart on these error types (permanent)
      exclude_error_types:
        - oom                # Out of memory - need config change
        - exception          # Python exceptions - likely code bug
        - torch              # Torch errors - likely code bug
        - numerical_instability  # NaN/Inf - need hyperparameter change

  - mode: stall
    implementation:
      class_name: AlwaysRestartPolicy
      reason: Job stalled (no progress), restarting
      max_retries: 2

  - mode: timeout
    implementation:
      class_name: AlwaysRestartPolicy
      reason: Job timeout, restarting
      max_retries: 1

  - mode: success
    implementation:
      class_name: NoRestartPolicy
      message: Job completed successfully
