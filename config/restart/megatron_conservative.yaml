# Conservative restart policy for Megatron
# Only restarts on known transient network/hang issues
# Does not restart on most errors - good for production where you want human review

policies:
  - mode: crash
    implementation:
      class_name: SelectiveRestartPolicy
      max_retries: 2
      restart_reason: Transient network/hang issue, restarting once
      stop_reason: Error requires investigation, stopping
      default_action: stop  # Conservative: don't restart unless explicitly listed

      # Only restart on clearly transient issues
      restart_on_error_types:
        - hang               # CUDA hangs - might be transient
        - nccl_timeout       # NCCL timeout - network issue
        - distributed_timeout # ProcessGroup timeout
        - watchdog_timeout   # Watchdog timeout

      restart_on_signals:
        - cuda_hang
        - nccl_timeout
        - processgroup_timeout

  - mode: stall
    implementation:
      class_name: AlwaysRestartPolicy
      reason: Job stalled without progress, restarting once
      max_retries: 1

  - mode: timeout
    implementation:
      class_name: NoRestartPolicy
      message: Job timeout - requires investigation

  - mode: success
    implementation:
      class_name: NoRestartPolicy
      message: Job completed successfully
