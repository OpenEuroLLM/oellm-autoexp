# Comprehensive Megatron monitoring for production runs
# UNCLEAR: inherits megatron_basic log_events + state events via defaults.
defaults:
  - megatron_basic
  - _self_

# Includes: success detection, OOM errors, NCCL issues, and stall detection
class_name: SlurmLogMonitor
poll_interval_seconds: 180
check_interval_seconds: 120
inactivity_threshold_seconds: 1200  # 20 minutes without updates = stalled
termination_string: null
termination_command: null
# SLURM variables: %j=job_id, %A=array_master_id, %a=array_task_id
log_path_template: "{output_dir}/slurm-${oc.if:${slurm.array},%A_%a,%j}.out"
output_paths: []
start_condition_cmd: null
start_condition_interval_seconds: null

log_events:
  # === SUCCESS SIGNALS ===

  - name: validation_complete
    pattern: 'validation loss at iteration \d+ on test set \| lm loss value: (?P<loss>[\d.E+\-]+)'
    pattern_type: regex
    state:
      class_name: SuccessState
    metadata:
      kind: completion
      stage: validation
    extract_groups:
      validation_loss: loss

  - name: checkpoint_saved
    pattern: 'successfully saved checkpoint from iteration\s+(?P<iteration>\d+) to (?P<path>\S+)'
    pattern_type: regex
    metadata:
      kind: checkpoint
    extract_groups:
      checkpoint_iteration: iteration
      checkpoint_path: path

  - name: training_iteration
    pattern: '\[[\d\-\s:]+\] iteration\s+(?P<current>\d+)/\s*(?P<total>\d+) \|.*lm loss: (?P<loss>[\d.E+\-]+)'
    pattern_type: regex
    metadata:
      kind: progress
    extract_groups:
      current_iteration: current
      total_iterations: total
      loss: loss

  # === MEMORY ERRORS ===

  - name: cuda_oom
    pattern: '(?:CUDA out of memory|OutOfMemoryError).*Tried to allocate (?P<size>[\d.]+\s*[KMGT]iB)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: oom
      subsystem: cuda
    extract_groups:
      allocation_size: size
    actions: []  # Do not restart on OOM; requires manual intervention
  - name: cpu_oom
    pattern: '(?:Cannot allocate memory|(?<!OutOf)MemoryError).*?(?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: oom
      subsystem: cpu
    extract_groups:
      error_message: message
    actions: []  # Do not restart on OOM; requires manual intervention
  # === NCCL/DISTRIBUTED ERRORS ===

  - name: nccl_error
    pattern: 'NCCL ERROR.*?(?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: nccl
      subsystem: distributed
    extract_groups:
      error_message: message
    actions:
      - class_name: RestartAction
        reason: "nccl error restart"

  - name: nccl_timeout
    pattern: 'NCCL.*timeout.*(?P<details>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: nccl_timeout
      subsystem: distributed
    extract_groups:
      timeout_details: details
    actions:
      - class_name: RestartAction
        reason: "nccl timeout restart"

  - name: processgroup_timeout
    pattern: '\[c10d\].*timeout.*(?P<details>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: distributed_timeout
      subsystem: distributed
    extract_groups:
      timeout_details: details
    actions:
      - class_name: RestartAction
        reason: "processgroup timeout restart"

  - name: communication_error
    pattern: '(?:socket|connection|comm).*(?:error|failed|abort).*?(?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: communication
      subsystem: distributed
    extract_groups:
      error_message: message
    actions:
      - class_name: RestartAction
        reason: "communication error restart"

  # === NUMERICAL STABILITY ===

  - name: loss_nan
    pattern: 'loss.*(?:NaN|nan)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: numerical_instability
      issue: loss_nan
    extract_groups:
      error_message: match

  - name: gradient_nan
    pattern: '(?:NaN|nan).*(?:gradient|grad)'
    pattern_type: regex
    metadata:
      severity: warning
      error_type: numerical_instability
      issue: gradient_nan
    extract_groups:
      warning_message: match

  # === HANGS/STALLS ===

  - name: cuda_hang
    pattern: '(?:CUDA.*(?:hang|stuck|frozen)|device-side assert).*?(?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: hang
      subsystem: cuda
    extract_groups:
      error_message: message
    actions:
      - class_name: RestartAction
        reason: "cuda hang restart"

  - name: deadlock
    pattern: '(?:deadlock|Deadlock|DEADLOCK).*?(?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: deadlock
      subsystem: distributed
    extract_groups:
      error_message: message
    actions:
      - class_name: RestartAction
        reason: "deadlock restart"

  # === GENERIC ERRORS ===

  - name: torch_error
    pattern: 'torch\.(?P<error_class>\w+Error): (?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: torch
    extract_groups:
      error_class: error_class
      error_message: message

  - name: python_exception
    pattern: '(?P<exception>(?:Runtime|Value|Type|Attribute|Key|Index)Error): (?P<message>.{0,200})'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: exception
    extract_groups:
      exception_type: exception
      error_message: message

state_events:
  - name: stall
    state:
      class_name: StalledState
    actions:
      - class_name: RestartAction
        reason: "log inactivity"
  - name: crash
    state:
      class_name: CrashState
    actions:
      - class_name: EventAction
        conditions:
          - class_name: MetadataCondition
            key: error_type
            equals: cancelled
        action:
          class_name: RestartAction
          reason: "retry cancelled job"
      - class_name: EventAction
        conditions:
          - class_name: MetadataCondition
            key: error_type
            equals: slurm_failure
        action:
          class_name: RestartAction
          reason: "retry slurm failure"
  - name: timeout
    state:
      class_name: TimeoutState
    actions:
      - class_name: RestartAction
        reason: "timeout restart"
  - name: success
    state:
      class_name: SuccessState
    actions:
      - class_name: LogAction
        message: "run_finished"
