# Basic Megatron monitoring for successful runs and common errors
class_name: SlurmLogMonitor
poll_interval_seconds: 30
check_interval_seconds: 30
inactivity_threshold_seconds: 1800  # 30 minutes without log updates
termination_string: null
termination_command: null
log_path: ${project.log_path_current}
output_paths: []
start_condition_cmd: null
start_condition_interval_seconds: null

log_events:
  # Success: validation loss reported (indicates training completed successfully)
  - name: validation_complete
    pattern: 'validation loss at iteration \d+ on test set \| lm loss value: (?P<loss>[\d.E+\-]+)'
    pattern_type: regex
    state:
      class_name: SuccessState
    metadata:
      kind: completion
      stage: validation
      note: run_finished
    extract_groups:
      validation_loss: loss

  # Success: checkpoint saved
  - name: checkpoint_saved
    pattern: 'successfully saved checkpoint from iteration\s+(?P<iteration>\d+) to (?P<path>\S+)'
    pattern_type: regex
    metadata:
      kind: checkpoint
      note: new_checkpoint
    extract_groups:
      checkpoint_iteration: iteration
      checkpoint_path: path

  # OOM Error: CUDA out of memory
  - name: cuda_oom
    pattern: '(?:CUDA out of memory|OutOfMemoryError).*Tried to allocate (?P<size>[\d.]+\s*[KMGT]iB)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: critical
      error_type: oom
      note: error
    extract_groups:
      allocation_size: size

  # Generic torch errors
  - name: torch_error
    pattern: 'torch\.(?P<error_class>\w+Error): (?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: torch
      note: error
    extract_groups:
      error_class: error_class
      error_message: message

  # Python exceptions
  - name: python_exception
    pattern: '(?P<exception>\w+Error): (?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    metadata:
      severity: error
      error_type: exception
      note: error
    extract_groups:
      exception_type: exception
      error_message: message

state_events:
  - name: stall
    state:
      class_name: StalledState
  - name: crash
    state:
      class_name: CrashState
  - name: timeout
    state:
      class_name: TimeoutState
  - name: success
    state:
      class_name: SuccessState
    actions:
      - class_name: LogAction
        message: "run_finished"
