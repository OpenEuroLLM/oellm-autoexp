# Megatron monitoring with NCCL error detection (for runs with NCCL_DEBUG=info)
defaults:
  - megatron_basic
  - _self_

# Override to check more frequently when monitoring NCCL issues
poll_interval_seconds: 180
check_interval_seconds: 120
inactivity_threshold_seconds: 1200  # 20 minutes (NCCL timeouts can be long)

log_signals:
  # All signals from megatron_basic, plus NCCL-specific ones:

  # NCCL ERROR messages
  - name: nccl_error
    pattern: 'NCCL ERROR.*?(?P<error_code>[\w]+).*?(?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    actions:
      - class_name: ErrorNoteAction
        note: error
      - class_name: RestartAction
        reason: nccl_error
        mode: crash
    metadata:
      severity: critical
      error_type: nccl
      subsystem: distributed
    extract_groups:
      nccl_error_code: error_code
      error_message: message

  # NCCL WARN messages (may indicate issues but not fatal)
  - name: nccl_warning
    pattern: 'NCCL WARN.*?(?P<message>.+)'
    pattern_type: regex
    actions:
      - class_name: ErrorNoteAction
        note: warning
    metadata:
      severity: warning
      error_type: nccl
      subsystem: distributed
    extract_groups:
      warning_message: message

  # NCCL timeout
  - name: nccl_timeout
    pattern: 'NCCL.*timeout.*(?P<details>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    actions:
      - class_name: ErrorNoteAction
        note: error
      - class_name: RestartAction
        reason: nccl_timeout
        mode: crash
    metadata:
      severity: critical
      error_type: nccl_timeout
      subsystem: distributed
    extract_groups:
      timeout_details: details

  # Communication errors (socket, connection issues)
  - name: communication_error
    pattern: '(?:socket|connection|comm).*(?:error|failed|abort).*?(?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    actions:
      - class_name: ErrorNoteAction
        note: error
      - class_name: RestartAction
        reason: communication_error
        mode: crash
    metadata:
      severity: error
      error_type: communication
      subsystem: distributed
    extract_groups:
      error_message: message

  # NCCL collective operation failures
  - name: nccl_collective_fail
    pattern: 'NCCL.*(?:allreduce|broadcast|reduce|allgather).*(?:failed|error).*(?P<message>.+)'
    pattern_type: regex
    state:
      class_name: CrashState
    actions:
      - class_name: ErrorNoteAction
        note: error
      - class_name: RestartAction
        reason: nccl_collective_fail
        mode: crash
    metadata:
      severity: critical
      error_type: nccl_collective
      subsystem: distributed
    extract_groups:
      error_message: message
